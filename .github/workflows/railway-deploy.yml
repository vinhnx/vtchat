name: Railway Deployment

on:
    push:
        branches:
            - main # Production deployment
            - dev # Development deployment
    pull_request:
        branches:
            - main
            - dev

env:
    RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
    # Deploy to development environment when pushing to dev branch
    deploy-development:
        name: Deploy to Development
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
        environment: development

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Railway CLI
              run: npm install -g @railway/cli

            - name: Deploy to Railway Development
              run: |
                  railway login --token $RAILWAY_TOKEN
                  railway link ${{ vars.RAILWAY_PROJECT_ID }} --environment development
                  railway up --detach
              env:
                  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

            - name: Comment deployment URL (Development)
              if: github.event_name == 'push'
              run: |
                  echo "‚úÖ Development deployment successful!"
                  echo "üåç URL: https://vtchat-web-development.up.railway.app"

    # Deploy to production environment when pushing to main branch
    deploy-production:
        name: Deploy to Production
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        environment: production

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Railway CLI
              run: npm install -g @railway/cli

            - name: Deploy to Railway Production
              run: |
                  railway login --token $RAILWAY_TOKEN
                  railway link ${{ vars.RAILWAY_PROJECT_ID }} --environment production
                  railway up --detach
              env:
                  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

            - name: Comment deployment URL (Production)
              if: github.event_name == 'push'
              run: |
                  echo "üöÄ Production deployment successful!"
                  echo "üåç URL: https://vtchat-web-production.up.railway.app"

    # Build validation for PRs
    validate-build:
        name: Validate Build
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install

            - name: Build project
              run: bun run build
              working-directory: apps/web

            - name: Type check
              run: bun run type-check
              working-directory: apps/web

            - name: Lint
              run: bun run lint
              working-directory: apps/web

            - name: Comment PR validation
              uses: actions/github-script@v7
              if: github.event_name == 'pull_request'
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: '‚úÖ Build validation passed! Ready for deployment after merge.'
                      })
